---
title: Prediction and Interaction
class_no: 13
class_date: Tuesday, Feb. 20
qrimage: qrcode.png
qrbottom: '-90%'
pageurl: "ees4760.jgilligan.org/Slides/Class_13"
pdfurl: "ees4760.jgilligan.org/Slides/Class_13/EES_4760_5760_Class_13_Slides.pdf"
course      : "EES 4760/5760"
course_name : "Agent-Based & Individual-Based Computational Modeling"
author      : "Jonathan Gilligan"
semester    : Spring
year        : 2018
output:
  revealjs.jg::revealjs_presentation
---
```{r utility_functions, cache = F, echo = F, eval = T, message=F, warning=F}
knitr::opts_chunk$set(cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE,
                      fig.height=8.5, fig.width=14, dpi=100,
                      dev='png',fig.path='assets/fig/',cache.path='./cache/')

find_semester_dir <- function(p = NULL) {
  if (is.null(p)) p <- getwd()
  p <- normalizePath(p)
  if (file.exists(file.path(p,'semester.yml'))) {
    return(p)
  } else {
    d <- dirname(p)
    if (d == p) return(NA)
    return(find_semester_dir(d))
  }
}

semester.dir <- find_semester_dir()
data.dir <- file.path(semester.dir, 'data')
script.dir <- file.path(semester.dir,'util_scripts')

source_semester_script <- function(script) {
  script_file <- file.path(script.dir, script)
  message("Running script", script_file)
  source(script_file, chdir = T)
}

eval_in_sem_script_dir <- function(expr, loc = script.dir) {
  this.dir <- getwd()
  setwd(loc)
  retval <- eval(expr)
  setwd(this.dir)
  invisible(retval)
}

library(tidyverse)
library(magrittr)
library(janitor)

theme_set(theme_bw(base_size = 15))
```
# Getting Started {.center}

## Getting Started  {.eighty}

Download

* <https://ees4760.jgilligan.org/models/class_13/BusinessInvestor.nlogo>
* <https://ees4760.jgilligan.org/models/class_13/BusinessInvestor_satisfice.nlogo>
* <https://ees4760.jgilligan.org/models/class_13/BusinessInvestor_bayesian.nlogo>
* <https://ees4760.jgilligan.org/models/class_13/jg-tif.nls>

# Prediction {.center}

## Prediction

> * What do investors want?
>   * Maximize their wealth over time
> * How do investors decide what patch to move to?
>   * _Predict_ what their wealth is likely to be after a certain number of
      ticks on each square.
      $$ U = (W + P \times T) \times (1 - F)^T $$
> * Farmer planting crops
>   * Predict what weather will be
>   * Predict what crops will be in demand at end of season
>   * Past experience, statistical analysis, ...
> * Predator chasing prey
>   * Predict where prey will be in order to intercept
>   * Extrapolate from current position, velocity ...

## Modeling Prediction

* Sensing: What do agents know?
* Cognition: How do agents think?
* Learning: Do agents learn from experience?

## Business Investor

> * How does agent decide how far into the future to try to predict expected utility?
> * How does this time horizon affect behaviors and outcomes?


. . .


* Interactive app <https://alo.ees.vanderbilt.edu/shiny/ees4760/contour/>

<div  style="padding-top:50px;">
<iframe height=450 width=1800 src="https://alo.ees.vanderbilt.edu/shiny/ees4760/contour/">
Open app at <https://alo.ees.vanderbilt.edu/shiny/ees4760/contour/>
</iframe>
</div>

## Varying Time Horizon: Wealth

```{r wealth-vs-horizon, include=TRUE}
bs_data <- read_csv("data/BusinessInvestor_vary-time-horizon-tabledata.csv")
bs_data <- bs_data %>% group_by(tick, time.horizon) %>% 
  summarize_at(vars(wealth, failures, profit, risk), funs(mean(.))) %>%
  ungroup()
```

```{r wealth-vs-horizon-detail, include=TRUE}
ggplot(bs_data, aes(x = time.horizon, y = wealth / 1000)) +
  geom_point(size = 3) + geom_line(size = 1) +
  ylim(115,135) +
  labs(x = "Time horizon (years)", y = "Mean final wealth (thousands)")

```

## Varying Time Horizon: Failures

```{r failures-vs-horizon, include=TRUE}
ggplot(bs_data, aes(x = time.horizon, y = failures)) +
  geom_point(size = 3) + geom_line(size = 1) +
  labs(x = "Time horizon (years)", y = "Mean # failures")

```

## Varying Time Horizon: Profit

```{r profit-vs-horizon, include=TRUE}
ggplot(bs_data, aes(x = time.horizon, y = profit / 1000)) +
  geom_point(size = 3) + geom_line(size = 1) +
  labs(x = "Time horizon (years)", y = "Mean profit of final patch (thousands)")

```

## Varying Time Horizon: Risk

```{r risk-vs-horizon, include=TRUE}
ggplot(bs_data, aes(x = time.horizon, y = risk)) +
  geom_point(size = 3) + geom_line(size = 1) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Time horizon (years)", y = "Mean risk of final patch")

```

# Modeling Prediction {.center}

## Investor Ignorance {.eighty}

> * Suppose the investor does not know risks of failure?
> * Learn about risk from experience
> * Bayesian updating:
>   * Start assuming that each patch has same risk (average)
>   * Each turn investors get new information about failures
>   * _beta_ function:
      $$F_{\text{est}} = \frac{\alpha}{\alpha + \beta}$$
      What are $\alpha$ and $\beta$?
>   * $\alpha$ represents number of failures on a patch
>   * $\beta$ represents number of non-failures
>   * Initial guess:
      $$\begin{aligned}
      \alpha &= (R^2 - R^3 - RV) / V\\
      \beta &= (R/V) (1 - R^2) + (R - 1),
      \end{aligned}$$
      where $R$ is the average risk across patches and
      $V$ is the variance of risk across patches.
>   * Every tick, increment $\alpha$ for patches with failures and increment
      $\beta$ for patches without failures.

## Experiment

* Open `BusinessInvestor_bayesian.nlogo`
